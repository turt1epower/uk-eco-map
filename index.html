<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>학교 생태지도</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif; margin:0; }
  .app { display:flex; height:100vh; }
  .map-wrap { position:relative; flex:1; overflow:auto; background:#f0f0f0; display:flex; align-items:center; justify-content:center; }
  .map-img { max-width:100%; height:auto; display:block; position:relative; cursor:crosshair; }
  .marker {
    position:absolute;
    transform:translate(-50%,-100%);
    width:28px; height:28px; border-radius:50%;
    background:rgba(34,139,34,0.95); border:2px solid #fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-weight:700; cursor:pointer;
  }
  .marker:after { content:""; position:absolute; left:50%; bottom:-8px; transform:translateX(-50%); width:2px; height:8px; background:rgba(34,139,34,0.95); }
  aside.panel {
    width:320px; max-width:40%; background:#fff; border-left:1px solid #e0e0e0; padding:16px; box-sizing:border-box;
  }
  .panel h2 { margin:0 0 8px 0; font-size:18px; display:flex; justify-content:space-between; align-items:center; }
  .panel img { width:100%; height:auto; border-radius:6px; margin-bottom:8px; }
  .close-btn, .edit-toggle, .btn { background:#eee; border:0; padding:6px 8px; border-radius:4px; cursor:pointer; margin-right:6px; }
  .hint { color:#666; font-size:14px; }
  .top-actions { display:flex; gap:8px; align-items:center; }
  /* 편집 폼 */
  .form-float {
    position: absolute;
    z-index: 50;
    background: #fff;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    width: 280px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }
  .form-float label { display:block; font-size:13px; margin-top:6px; color:#333; }
  .form-float input[type="text"], .form-float textarea { width:100%; box-sizing:border-box; padding:6px; margin-top:4px; font-size:13px; border:1px solid #ccc; border-radius:4px; }
  .form-actions { margin-top:8px; display:flex; justify-content:flex-end; gap:6px; }
  @media(max-width:700px){ .panel{ position:fixed; right:0; top:0; bottom:0; z-index:30; width:90%; } }
</style>
</head>
<body>
<div class="app">
  <div class="map-wrap" id="mapWrap">
    <!-- map/ 폴더에 올려둔 지도 이미지 파일명으로 바꿔 주세요 -->
    <img id="mapImg" class="map-img" src="map/school-map.jpg" alt="학교 지도" />
  </div>

  <aside class="panel" id="panel" aria-hidden="true">
    <h2>
      <span>식물 정보</span>
      <div class="top-actions">
        <button id="editToggle" class="edit-toggle" type="button">편집 켜기</button>
        <button id="downloadBtn" class="btn" type="button">JSON 다운로드</button>
        <button id="copyBtn" class="btn" type="button">클립보드 복사</button>
      </div>
    </h2>
    <div id="panelContent">
      <button class="close-btn" id="closeBtn">닫기</button>
      <div id="details">
        <p class="hint">지도에서 식물 이름(녹색 점)을 클릭하세요.</p>
      </div>
    </div>
  </aside>
</div>

<!-- 편집 폼 템플릿 -->
<div id="formTemplate" style="display:none;">
  <div class="form-float" id="editForm">
    <div><strong>새 식물 등록</strong></div>
    <label>id
      <input id="f_id" type="text" placeholder="예: pine-tree" />
    </label>
    <label>이름
      <input id="f_name" type="text" placeholder="예: 소나무" />
    </label>
    <label>레이블(마커 안 짧은 텍스트)
      <input id="f_label" type="text" placeholder="예: 소" />
    </label>
    <label>사진 경로
      <input id="f_photo" type="text" placeholder="예: photo/pine-tree/1.jpg" />
    </label>
    <label>설명
      <textarea id="f_description" rows="3" placeholder="간단한 설명"></textarea>
    </label>
    <input id="f_x" type="hidden" />
    <input id="f_y" type="hidden" />
    <div class="form-actions">
      <button id="cancelAdd" class="btn" type="button">취소</button>
      <button id="saveAdd" class="btn" type="button">저장</button>
    </div>
  </div>
</div>

<script>
(async function(){
  const dataUrl = './data/plants.json';
  let plants = [];
  try {
    const res = await fetch(dataUrl);
    plants = await res.json();
  } catch(e){
    console.error('plants.json 로딩 실패', e);
    document.getElementById('details').innerText = '식물 데이터 로딩 실패';
    return;
  }

  const mapWrap = document.getElementById('mapWrap');
  const mapImg = document.getElementById('mapImg');
  const panel = document.getElementById('panel');
  const details = document.getElementById('details');
  const closeBtn = document.getElementById('closeBtn');
  const editToggle = document.getElementById('editToggle');
  const downloadBtn = document.getElementById('downloadBtn');
  const copyBtn = document.getElementById('copyBtn');

  let editMode = false;
  let currentFormEl = null;

  // 마커 생성 함수
  function createMarker(p){
    const m = document.createElement('button');
    m.className = 'marker';
    m.type = 'button';
    m.title = p.name;
    m.style.left = p.x + '%';
    m.style.top = p.y + '%';
    m.dataset.id = p.id;
    m.textContent = p.label || '●';
    m.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      showPlant(p);
    });
    mapWrap.appendChild(m);
    return m;
  }

  // 초기 마커 생성
  plants.forEach(p=> createMarker(p));

  mapWrap.addEventListener('click', (ev)=> {
    // 지도에서 클릭했을 때: 편집 모드면 폼 열기, 아니면 패널 닫기
    if (editMode) {
      // 클릭이 이미지 위에서 일어났는지 확인
      if (ev.target === mapImg) {
        const rect = mapImg.getBoundingClientRect();
        const x = ((ev.clientX - rect.left) / rect.width) * 100;
        const y = ((ev.clientY - rect.top) / rect.height) * 100;
        openAddForm(ev.clientX, ev.clientY, Math.round(x*100)/100, Math.round(y*100)/100);
      }
    } else {
      hidePanel();
    }
  });

  closeBtn.addEventListener('click', ()=> hidePanel());

  editToggle.addEventListener('click', ()=> {
    editMode = !editMode;
    editToggle.textContent = editMode ? '편집 끄기' : '편집 켜기';
    editToggle.style.background = editMode ? '#cfeecd' : '#eee';
    // 폼이 열려있으면 닫기
    removeForm();
  });

  downloadBtn.addEventListener('click', ()=> downloadJson());
  copyBtn.addEventListener('click', ()=> copyJson());

  function showPlant(p){
    panel.setAttribute('aria-hidden','false');
    details.innerHTML = `
      <h3>${escapeHtml(p.name)}</h3>
      <img src="${escapeHtml(p.photo)}" alt="${escapeHtml(p.name)} 사진" onerror="this.style.display='none'"/>
      <p>${escapeHtml(p.description || '설명이 아직 없습니다.')}</p>
    `;
  }
  function hidePanel(){
    panel.setAttribute('aria-hidden','true');
    details.innerHTML = '<p class="hint">지도에서 식물 이름(녹색 점)을 클릭하세요.</p>';
  }

  // 편집 폼 열기: 화면 좌표로 위치 지정
  function openAddForm(screenX, screenY, xPercent, yPercent){
    removeForm();
    const tpl = document.getElementById('formTemplate').firstElementChild.cloneNode(true);
    document.body.appendChild(tpl);
    currentFormEl = tpl;
    // 위치 보정: 폼이 화면을 넘어가지 않도록
    const left = Math.min(screenX + 8, window.innerWidth - 300);
    const top = Math.min(screenY + 8, window.innerHeight - 200);
    tpl.style.left = left + 'px';
    tpl.style.top = top + 'px';

    // 채우기
    tpl.querySelector('#f_x').value = xPercent;
    tpl.querySelector('#f_y').value = yPercent;
    tpl.querySelector('#f_photo').value = '';
    tpl.querySelector('#f_label').value = '';
    tpl.querySelector('#f_name').value = '';
    tpl.querySelector('#f_id').value = `${Date.now()}`; // 임시 id 제안

    // 임시 마커 표시
    const tempMarker = document.createElement('div');
    tempMarker.className = 'marker';
    tempMarker.style.left = xPercent + '%';
    tempMarker.style.top = yPercent + '%';
    tempMarker.textContent = '+';
    tempMarker.style.background = 'rgba(0,123,255,0.95)';
    tempMarker.style.zIndex = 45;
    mapWrap.appendChild(tempMarker);

    // 버튼 이벤트
    tpl.querySelector('#cancelAdd').addEventListener('click', ()=>{
      tempMarker.remove();
      removeForm();
    });
    tpl.querySelector('#saveAdd').addEventListener('click', ()=>{
      const id = tpl.querySelector('#f_id').value.trim() || `p${Date.now()}`;
      const name = tpl.querySelector('#f_name').value.trim() || '이름 없음';
      const label = tpl.querySelector('#f_label').value.trim() || '';
      const photo = tpl.querySelector('#f_photo').value.trim() || '';
      const description = tpl.querySelector('#f_description').value.trim() || '';
      const x = parseFloat(tpl.querySelector('#f_x').value);
      const y = parseFloat(tpl.querySelector('#f_y').value);

      const newPlant = { id, name, label, photo, description, x, y };
      plants.push(newPlant);
      // permanent marker
      createMarker(newPlant);
      tempMarker.remove();
      removeForm();
      // 패널에 새 항목 표시
      showPlant(newPlant);
    });
  }

  function removeForm(){
    if (currentFormEl) {
      currentFormEl.remove();
      currentFormEl = null;
    }
    // 임시 마커 있을 경우 제거 (클린업)
    Array.from(mapWrap.querySelectorAll('.marker')).forEach(m=>{
      // 임시 마커는 + 텍스트와 파란 배경으로 생성했음
      if (m.textContent === '+' && m.style.background.includes('rgb')) {
        m.remove();
      }
    });
  }

  // JSON 다운로드
  function downloadJson(){
    const blob = new Blob([JSON.stringify(plants, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'plants.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  // 클립보드 복사
  async function copyJson(){
    try {
      await navigator.clipboard.writeText(JSON.stringify(plants, null, 2));
      alert('JSON이 클립보드에 복사되었습니다. data/plants.json에 붙여넣기 하세요.');
    } catch(e) {
      alert('클립보드 복사 실패: 다운로드 버튼을 사용하세요.');
    }
  }

  // 간단한 escape (보안)
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

})();
</script>
</body>
</html>